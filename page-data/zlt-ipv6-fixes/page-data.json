{"componentChunkName":"component---src-templates-blog-post-js","path":"/zlt-ipv6-fixes/","result":{"data":{"site":{"siteMetadata":{"title":"Miyuru Tech Blog"}},"markdownRemark":{"id":"ae36da97-be68-5ee0-93f9-2c92cb79739f","excerpt":"Introduction As mentioned in the previous post, I reached out to the ISP to solve the issues, but only got feedback: ‚ÄúThe necessary corrections will be made by‚Ä¶","html":"<h2>Introduction</h2>\n<p>As mentioned in the <a href=\"https://blog.miyuru.lk/s12-pro-ipv6-issue/\">previous post</a>, I reached out to the ISP to solve the issues, but only got feedback: <em>‚ÄúThe necessary corrections will be made by the technical team.‚Äù</em></p>\n<p>That didn‚Äôt help, so I decided to take matters into my own hands after watching a YouTube video on gaining telnet access to the router.</p>\n<blockquote>\n<p>üìù <strong>Note:</strong> I am using a ZLT S12 Pro router, and I have seen the same issues on the ZLT X25 PRO 5G. Most ZTE routers likely still use the same broken scripts.</p>\n</blockquote>\n<blockquote>\n<p>‚ö†Ô∏è <strong>Disclaimer:</strong> These fixes are relatively harmless, but they might make your device unstable if applied incorrectly. Know what you are doing before applying the changes.</p>\n</blockquote>\n<hr>\n<h2>Prerequisites: Get Telnet Access</h2>\n<p>You need to enable telnet on the router. The exact method may vary, but a quick search for your model should provide instructions.</p>\n<p><strong>Hint:</strong> You can find the steps for the S12 Pro model <a href=\"#resources\">here</a>.</p>\n<hr>\n<h2>Fix 1: Adjust IPv6 Router Lifetime</h2>\n<p>The first issue was that IPv6 router advertisements (RA) had too short a lifetime, causing clients to drop their IPv6 addresses frequently.</p>\n<p>We can fix it by increasing <code class=\"language-text\">ra_lifetime</code> and enabling <code class=\"language-text\">ra_useleasetime</code>:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">uci </span><span class=\"mtk15\">set</span><span class=\"mtk1\"> dhcp.lan.ra_lifetime=</span><span class=\"mtk11\">&#39;1800&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">uci </span><span class=\"mtk15\">set</span><span class=\"mtk1\"> dhcp.lan.ra_useleasetime=</span><span class=\"mtk11\">&#39;1&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">uci commit dhcp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">/etc/init.d/odhcpd restart</span></span></span></code></pre>\n<p>Reference: <a href=\"https://openwrt.org/docs/guide-user/base-system/dhcp\">OpenWrt DHCP Configuration</a></p>\n<p>You can verify the change with <code class=\"language-text\">rdisc6</code>. After the fix, the RA output router lifetime of 1800 seconds:</p>\n<hr>\n<h2>Fix 2: DHCPv6 Script Improvements</h2>\n<p>The main IPv6 problems of this router seem to stem from a broken DHCPv6 script.</p>\n<h3>2.1 Fixing Preferred and Valid Lifetimes</h3>\n<p>The router tries to implement a custom version of <a href=\"https://datatracker.ietf.org/doc/html/rfc7278\">RFC 7278</a>. From my testing, the valid and preferred lifetimes are taken from the IPv6 prefix assigned to the <code class=\"language-text\">br-lan</code> interface. The script at <code class=\"language-text\">/lib/netifd/dhcpv6.script</code> contains these problematic lines:</p>\n<p><strong>Always take a backup before making changes:</strong></p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cp /lib/netifd/dhcpv6.script /lib/netifd/dhcpv6.script.bak</span></span></span></code></pre>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">addr_pref=</span><span class=\"mtk11\">$(echo $ADDRESSES </span><span class=\"mtk7\">|</span><span class=\"mtk11\"> cut -d &#39;,&#39; -f 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ $addr_pref </span><span class=\"mtk7\">-gt</span><span class=\"mtk1\"> 240 ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> addr_pref=240</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">addr_valid=</span><span class=\"mtk11\">$(echo $ADDRESSES </span><span class=\"mtk7\">|</span><span class=\"mtk11\"> cut -d &#39;,&#39; -f 3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[ $addr_valid </span><span class=\"mtk7\">-gt</span><span class=\"mtk1\"> 300 ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> addr_valid=300</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ip addr add ${addr}/$mask dev br-${lan_section} preferred_lft $addr_pref valid_lft $addr_valid</span></span></span></code></pre>\n<p>The script caps the preferred lifetime at 240 seconds and the valid lifetime at 300 seconds, which is far too short and create the decreasing values probem, snce it seem to think this is a link.</p>\n<p><strong>Fix:</strong> Comment out or delete those lines, and use a simpler <code class=\"language-text\">ip addr add</code> without explicit lifetimes.</p>\n<p>After this change, the router will assign proper lifetimes, as seen in the <code class=\"language-text\">rdisc6</code> output below.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Soliciting ff02::2 (ff02::2) on wlp0s20f3...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Hop limit                 </span><span class=\"mtk15\">:</span><span class=\"mtk1\">           64 (      0x40)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Stateful address conf.    </span><span class=\"mtk15\">:</span><span class=\"mtk1\">           No</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Stateful other conf.      </span><span class=\"mtk15\">:</span><span class=\"mtk1\">          Yes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Mobile home agent         </span><span class=\"mtk15\">:</span><span class=\"mtk1\">           No</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Router preference         </span><span class=\"mtk15\">:</span><span class=\"mtk1\">       medium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Neighbor discovery proxy  </span><span class=\"mtk15\">:</span><span class=\"mtk1\">           No</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Router lifetime           </span><span class=\"mtk15\">:</span><span class=\"mtk1\">         1800 (0x00000708) seconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Reachable </span><span class=\"mtk7\">time</span><span class=\"mtk1\">            </span><span class=\"mtk15\">:</span><span class=\"mtk1\">  unspecified (0x00000000)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">Retransmit </span><span class=\"mtk7\">time</span><span class=\"mtk1\">           </span><span class=\"mtk15\">:</span><span class=\"mtk1\">  unspecified (0x00000000)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> Source link-layer address: 98:A9:42:9C:68:21</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> MTU                      </span><span class=\"mtk15\">:</span><span class=\"mtk1\">         1500 bytes (valid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> Prefix                   </span><span class=\"mtk15\">:</span><span class=\"mtk1\"> 2001:db8:a400:2e76::/64</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  On-link                 </span><span class=\"mtk15\">:</span><span class=\"mtk1\">          Yes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Autonomous address conf.:          Yes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Valid </span><span class=\"mtk7\">time</span><span class=\"mtk1\">              </span><span class=\"mtk15\">:</span><span class=\"mtk1\">        86400 (0x00015180) seconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  Pref. </span><span class=\"mtk7\">time</span><span class=\"mtk1\">              </span><span class=\"mtk15\">:</span><span class=\"mtk1\">        86400 (0x00015180) seconds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> Recursive DNS server     </span><span class=\"mtk15\">:</span><span class=\"mtk1\"> 2001:db8:a400:2e76:60b9:9aff:fe2d:b1e</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  DNS server lifetime     </span><span class=\"mtk15\">:</span><span class=\"mtk1\">         1800 (0x00000708) seconds</span></span></span></code></pre>\n<h3>2.2 Preventing Unnecessary Address Deletion</h3>\n<p>Even after fixing lifetimes, disconnections still occurred because of this loop in the same script:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> temp </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> </span><span class=\"mtk11\">$(ip addr show dev br-${lan_section} </span><span class=\"mtk7\">|</span><span class=\"mtk11\"> grep inet6 </span><span class=\"mtk7\">|</span><span class=\"mtk11\"> grep global </span><span class=\"mtk7\">|</span><span class=\"mtk11\"> awk &#39;{print $2}&#39;)</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ip addr del $temp dev br-${lan_section}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">done</span></span></span></code></pre>\n<p>It removes <strong>all</strong> global IPv6 addresses every time the script runs, which is why IPv6 disconnected from time to time.\nThe better way is to check and remove addresses that differ from the new one being added.</p>\n<p>I replaced that block with a new function so that we can fix the both issues in one go:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Function to update IPv6 address on bridge interface</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Parameters: $1 = new address (with mask), $2 = bridge interface name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">update_ipv6_address</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> new_addr=</span><span class=\"mtk11\">&quot;$1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">local</span><span class=\"mtk1\"> bridge_interface=</span><span class=\"mtk11\">&quot;$2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Remove existing global IPv6 addresses only if different from new address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Combined grep|grep|awk into single awk for better performance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ip addr show dev </span><span class=\"mtk11\">&quot;$bridge_interface&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> awk </span><span class=\"mtk11\">&#39;/inet6.*global/ {print $2}&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">|</span><span class=\"mtk1\"> </span><span class=\"mtk7\">while</span><span class=\"mtk1\"> </span><span class=\"mtk15\">read</span><span class=\"mtk1\"> -r temp</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\"># Only delete if address is different from the one we&#39;re adding</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ </span><span class=\"mtk11\">&quot;$temp&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;$new_addr&quot;</span><span class=\"mtk1\"> ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ip addr del </span><span class=\"mtk11\">&quot;$temp&quot;</span><span class=\"mtk1\"> dev </span><span class=\"mtk11\">&quot;$bridge_interface&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># Add new IPv6 address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ip addr add </span><span class=\"mtk11\">&quot;$new_addr&quot;</span><span class=\"mtk1\"> dev </span><span class=\"mtk11\">&quot;$bridge_interface&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Hint:</strong> You can find the complete modified script for the S12 Pro model at the bottom of this <a href=\"#resources\">article</a>.</p>\n<p>Replace the old deletion+addition code with a call to this function. After updating the script, IPv6 addresses persist correctly.</p>\n<hr>\n<h2>Fix 3: Disable NAT66 Masquerade</h2>\n<p>Even after fixing disconnections, I noticed that all devices behind the router appeared to have the same public IPv6 address. The router was performing NAT66 on the <code class=\"language-text\">br-lan</code> interface. We can confirm this with:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ip6tables -t nat -vnL --line-numbers</span></span></span></code></pre>\n<p>Example output:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Chain POSTROUTING (policy ACCEPT 21 packets, 1763 bytes)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">num   pkts bytes target     prot opt in     out     source               destination         </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1      112 51586 MASQUERADE  all      *      usb0    ::/0                 ::/0   </span></span></code></pre>\n<p>The masquerade rule was added by a script at <code class=\"language-text\">/usr/lib/lua/tz/firewall.sh</code> with a comment, that explains the whole situation clearly.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># temporary fix for broken IPv6 function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ipv6_masq=1</span></span></span></code></pre>\n<p>This is the relevant section that uses the var:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> [ $main_apn_nat </span><span class=\"mtk7\">-eq</span><span class=\"mtk1\"> 1 ]</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> temp_if </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> </span><span class=\"mtk11\">$(uci get network.4g.ifname)</span><span class=\"mtk7\">;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        iptables -w -t nat -A POSTROUTING -o $temp_if -j MASQUERADE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [ </span><span class=\"mtk11\">&quot;$ipv6_masq&quot;</span><span class=\"mtk1\"> ] </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> ip6tables -w -t nat -A POSTROUTING -o $temp_if -j MASQUERADE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">fi</span></span></span></code></pre>\n<p>To permanently disable IPv6 masquerade, we can set the <code class=\"language-text\">$ipv6_masq</code> variable to empty and reboot:</p>\n<p><strong>Backup first:</strong></p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cp /usr/lib/lua/tz/firewall.sh /usr/lib/lua/tz/firewall.sh.bak</span></span></span></code></pre>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sed -i </span><span class=\"mtk11\">&#39;s/ipv6_masq=1/ipv6_masq=/g&#39;</span><span class=\"mtk1\"> /usr/lib/lua/tz/firewall.sh</span></span></span></code></pre>\n<p>To apply immediately without reboot, delete the NAT rule:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ip6tables -t nat -D POSTROUTING 1</span></span></span></code></pre>\n<p>Now each device gets its own global IPv6 address as intended.</p>\n<hr>\n<h2>Bonus: Reduce System Load by Fixing wand Logging</h2>\n<p>During debugging, I noticed the router‚Äôs load average was constantly around 1. A quick <code class=\"language-text\">top</code> showed a <code class=\"language-text\">wc -c</code> process eating CPU:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2834  2833 root     R     1380   1%  23% wc -c /tmp/logs/wand.log</span></span></code></pre>\n<p>The log file <code class=\"language-text\">/tmp/logs/wand.log</code> had grown huge. This logging comes from the script <code class=\"language-text\">/bin/wand</code>. The original script continuously appends to the log and also checks its size for rotation, using <code class=\"language-text\">wc -c</code> which reads the entire file each time‚Äîexpensive on a large file.</p>\n<p><strong>Fix:</strong> Comment out all logging and log‚Äërotation lines. Here‚Äôs the diff of the modified portion of the script with comments:</p>\n<p><strong>Backup first:</strong></p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cp /bin/wand /bin/wand.bak</span></span></span></code></pre>\n<pre class=\"grvsc-container abyss\" data-language=\"diff\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-echo &quot;wand started at[$(cat /proc/uptime | cut -d &#39; &#39; -f 1)], pid[$$]&quot; &gt;&gt;$log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+# Initial startup log - COMMENTED OUT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+# echo &quot;wand started at[$(cat /proc/uptime | cut -d &#39; &#39; -f 1)], pid[$$]&quot; &gt;&gt;$log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> while true; do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Write current process ID to PID file for tracking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         echo $$ &gt;$pid_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Update last active timestamp (system uptime in seconds)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         cat /proc/uptime | awk -F &#39;.&#39; &#39;{print $1}&#39; &gt;/tmp/.wand/last_active</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        set -x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        cat /proc/uptime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Debug output - COMMENTED OUT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # set -x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # cat /proc/uptime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Create timeout task if tick counter exceeds check interval</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if [ $tick -gt $check_interval ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 touch $task_dir/timeout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Process all pending tasks in task directory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         while true; do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 no_task=1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-                for i in $(ls $task_dir); do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+                for i in $(ls $task_dir 2&gt;/dev/null); do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+                        # Remove task file and execute failover</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         rm -rf $task_dir/$i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         run_wan_failover</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+                        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+                        # Reset tick counter after task execution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         tick=0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         no_task=0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                         break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+                # Exit loop if no tasks found</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                 [ $no_task -eq 1 ] &amp;&amp; break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         done</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Monitor DNS resolver configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         watch_resolv</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Increment tick counter and wait</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         tick=$(($tick + $tick_step))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         sleep $tick_step</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        set +x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        log_size=$(wc -c $log_file | awk &#39;{print $1}&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        [ -z &quot;$log_size&quot; ] &amp;&amp; log_size=0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        if [ $log_size -gt $log_max_size ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-                rm -f $pid_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-                gzip -kf $log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-                &gt;$log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-        fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk14\">-done &gt;&gt;$log_file 2&gt;&amp;1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Debug output end - COMMENTED OUT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # set +x</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # Log rotation logic - COMMENTED OUT (not needed without logging)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # log_size=$(wc -c $log_file 2&gt;/dev/null | awk &#39;{print $1}&#39;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # [ -z &quot;$log_size&quot; ] &amp;&amp; log_size=0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # if [ $log_size -gt $log_max_size ]; then</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        #         rm -f $pid_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        #         gzip -kf $log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        #         &gt;$log_file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        # fi</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk16\">+done # Removed: &gt;&gt;$log_file 2&gt;&amp;1 (log redirection commented out)</span></span></span></code></pre>\n<p><strong>Hint:</strong> The complete modified <code class=\"language-text\">wand</code> script for the S12 Pro is available at the bottom of this <a href=\"#resources\">article</a>.</p>\n<p>After editing the file, restart the service:</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">/etc/init.d/wand restart</span></span></span></code></pre>\n<p>The load average dropped back to normal.</p>\n<hr>\n<h2>Persistence</h2>\n<p>All script changes made are permanent and survive a reboot. Reset will revert only the configs set via <code class=\"language-text\">uci</code> (Fix 1).</p>\n<h2>Conclusion</h2>\n<p>After applying these changes, the router became much more stable, and IPv6 now works as intended on all devices.</p>\n<p>Most of the problems stem from the fact that there is no proper DHCP‚ÄëPD for end devices, and <a href=\"https://blog.miyuru.lk/server-provider-deploy-ipv6-correctly/\">ISPs are still trying to apply legacy v4 practices to IPv6</a>. Hopefully, this situation will improve in the future.</p>\n<h2>Resources</h2>\n<blockquote>\n<p><strong>‚ùó Always make a copy of the original files before applying any modifications, and compare the differences to understand the changes.</strong></p>\n</blockquote>\n<ul>\n<li>Modified scripts for ZLT S12 Pro:\n<ul>\n<li><a href=\"/1772291174219.66537872741/new_dhcpv6.sh\"><code class=\"language-text\">new_dhcpv6.sh</code></a></li>\n<li><a href=\"/1772291174219.66537872743/new_wand.sh\"><code class=\"language-text\">new_wand.sh</code></a></li>\n<li><a href=\"/1772291174219.66537872742/new_firewall.sh\"><code class=\"language-text\">new_firewall.sh</code></a></li>\n<li><a href=\"/1772291174219.6017872739/how_to_telnet.txt\"><code class=\"language-text\">how_to_telnet.txt</code></a></li>\n</ul>\n</li>\n</ul>\n<hr>\n<p>This project took 2 days of research and testing. If you found this helpful, consider supporting me via <a href=\"https://donate.stripe.com/00wdR98qH1vR41yfxKbfO01\">here</a>.</p>\n<p>Please add a note about this blog post so I know it‚Äôs from here.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .abyss { background-color: #000c18; }\n  .abyss .mtk1 { color: #6688CC; }\n  .abyss .mtk15 { color: #9966B8; }\n  .abyss .mtk11 { color: #22AA44; }\n  .abyss .mtk7 { color: #225588; }\n  .abyss .mtk3 { color: #384887; }\n  .abyss .mtk6 { color: #DDBB88; }\n  .abyss .mtk14 { color: #DC322F; }\n  .abyss .mtk16 { color: #219186; }\n  .abyss .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Fixing IPv6 and Performance Issues on ZLT S12 Pro Router (OpenWrt)","date":"February 26, 2026","description":"I repaired the ZLT S12 Pro‚Äôs buggy OpenWrt firmware via telnet after ISP support fell short. By patching DHCPv6 scripts and killing a runaway logging process, I achieved stable IPv6 connectivity and lower system load."}},"previous":{"fields":{"slug":"/s12-pro-ipv6-issue/"},"frontmatter":{"title":"IPv6 Keeps Breaking on Android with ZLT S12 Pro Router"}},"next":null},"pageContext":{"id":"ae36da97-be68-5ee0-93f9-2c92cb79739f","previousPostId":"fd92af3f-2f13-5037-93e6-e6b71d4c7a2a","nextPostId":null}},"staticQueryHashes":["1888224856","2841359383"],"slicesMap":{}}