{"componentChunkName":"component---src-templates-blog-post-js","path":"/setup-wireguard-with-global-ipv6/","result":{"data":{"site":{"siteMetadata":{"title":"Miyuru Tech Blog"}},"markdownRemark":{"id":"56eafbb9-6e1d-5d04-a175-202b73af7b99","excerpt":"WireGuard is becoming popular with the linux crowd as a VPN as its integrated with the linux kernel whitch provides better performance. However lot of tutorials…","html":"<p>WireGuard is becoming popular with the linux crowd as a VPN as its integrated with the linux kernel whitch provides better performance.</p>\n<p>However lot of tutorials and scripts that setup wireguard do so with NATing the IPv6 address and giving the user a link local IPv6 address. This causes the operating system to prefer IPv4 over IPv6. In this tutorial we will look at setting up a simple dual stacked vpn tunnel with global IPv6 support.</p>\n<p>I will be using a t4g.nano server in aws eu-central-1 with Debian bullseye and use add a single /80 ipv6 subnet for the instance. Some of the steps will be different for your setup.</p>\n<h2>Network Setup</h2>\n<p>For this tutorial I will be only focusing on IPv6 network configuration.</p>\n<p>You will need a subnet with /80 for this tutorial, However you can use smaller subnets with proper subnetting.</p>\n<blockquote>\n<p>⚠️ Please substitute your own subnet and network interfaces when following the tutorial.</p>\n</blockquote>\n<p><strong>Original Block - 2001:db8::ffaa:87dd::/80</strong></p>\n<ul>\n<li>For the SSH - 2001:db8::ffaa:87dd::1/128</li>\n<li>For the VPN Endpoint - 2001:db8::ffaa:87dd::123/128</li>\n<li>For the VPN Clients - 2001:db8::ffaa:87dd:ffff::/96</li>\n<li>VPN Endpoint port - 60002</li>\n<li>AWS network interface - ens5</li>\n</ul>\n<p>We are also giving a single IPv6 for each client but you can also give a subnet per client.\nFor a truly proper IPv6 config you can give each client a /64 subnet and configure SLAAC.</p>\n<p>Run the following commands to add the ips to the interface</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo ip addr add 2001:db8::ffaa:87dd::1/128 dev ens5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo ip addr add 2001:db8::ffaa:87dd::123/128 dev ens5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo ip addr add 2001:db8::ffaa:87dd:ffff::/96 dev ens5</span></span></code></pre>\n<blockquote>\n<p>⚠️ You can also use tools like netplan to properly setup the IPs.</p>\n</blockquote>\n<p>Make sure to add the following to <code class=\"language-text\">/etc/sysctl.d/wg.conf</code></p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">net.ipv4.ip_forward = 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">net.ipv6.conf.all.forwarding = 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">net.ipv6.conf.ens5.accept_ra = 2</span></span></code></pre>\n<p>Run following command to apply the changes.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo sysctl --system</span></span></code></pre>\n<h2>Installing WireGuard</h2>\n<p>To install WireGuard use the package manager of the system or follow the <a href=\"https://www.wireguard.com/install/\">quickstart</a>.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo apt install wireguard</span></span></code></pre>\n<h2>Server WG0 Configuration</h2>\n<p>In the IPv4 rules, we NATing the IPv4 address.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PostUp =  iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE; </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostDown = iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE;</span></span></code></pre>\n<p>In the IPv6 rules, we are adding a rule to forward traffic to the internet interface.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">PostUp = ip6tables -A FORWARD -i ens5 -o wg0 -j ACCEPT; ip6tables -A FORWARD -i wg0 -j ACCEPT;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostDown = ip6tables -D FORWARD -i ens5 -o wg0 -j ACCEPT; ip6tables -D FORWARD -i wg0 -j ACCEPT;</span></span></code></pre>\n<p>For the client IP we are using the first IPs of the designated range. In IPv6 you can allow a large subnet here and it will allow the client to move around within different IPs of the subnet.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">AllowedIPs = 10.66.66.2, 2001:db8::ffaa:87dd:ffff::2/128</span></span></code></pre>\n<p>Below is the full config. Save the file in <code class=\"language-text\">/etc/wireguard/wg0.conf</code></p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[Interface]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Address = 10.66.66.1/24, fd42:42:42::1/64</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">ListenPort = 60002</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PrivateKey = </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostUp =  iptables -t nat -A POSTROUTING -o ens5 -j MASQUERADE; ip6tables -A FORWARD -i ens5 -o wg0 -j ACCEPT; ip6tables -A FORWARD -i wg0 -j ACCEPT;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PostDown = iptables -t nat -D POSTROUTING -o ens5 -j MASQUERADE; ip6tables -D FORWARD -i ens5 -o wg0 -j ACCEPT; ip6tables -D FORWARD -i wg0 -j ACCEPT;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#### Client 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[Peer]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PublicKey =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#PresharedKey =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AllowedIPs = 10.66.66.2, 2001:db8::ffaa:87dd:ffff::2/128</span></span></code></pre>\n<p>To start the tunnel run the following command</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo wg-quick up wg0</span></span></code></pre>\n<h2>Client Configuration</h2>\n<p>Here we are allowing a single IPv6 address. If the server config is allowing a large subnet, we can change it accordingly.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Address = 10.66.66.2, 2001:db8::ffaa:87dd:ffff::2/128</span></span></code></pre>\n<p>Below is the full config. Save the file in <code class=\"language-text\">/etc/wireguard/client1.conf</code></p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[Interface]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PrivateKey =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Address = 10.66.66.2, 2001:db8::ffaa:87dd:ffff::2/128</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">DNS =  2606:4700:4700::1001</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[Peer]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">PublicKey =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#PresharedKey =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">AllowedIPs = 0.0.0.0/0, ::/0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Endpoint = [2001:db8::ffaa:87dd::123]:60002</span></span></code></pre>\n<p>To start the tunnel run the following command in linux.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sudo wg-quick up wg0</span></span></code></pre>\n<h2>Testing</h2>\n<p>After setting up the VPN you can test the connetion by going to test-ipv6.com</p>\n<p>You can see that the IPv6 address is preferred over the IPv4 address.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1772291174218.96857872734/a80b8/wg-ipv6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABG3AAARtwGaY1MrAAACCklEQVR42m1SyY7UMBTMt3NC4g9ampkPQOKMEHAYDiya6Qaa4TBcuoekO5vtxI63bMWzQ+cCjkq2HLte1SsnRVEgL3JUvIJoBJqmQdu2K1jNULMaaZGi4MU/4ILHc4GHMYbEGY9MnvD2+B6VqRHGNE2Y5zmi72dkLMPV9grX2+tl3l3jZneDzf0GB35Abz3KqozESZEX0NaiYFRJShhjMBLhZRg/kgqBNM9QCwbZSprr6CigaRtIuhfUCVKbLCp6siqogoQge1a1K2E/TpBKouUNmOb4cvoM21uM44h5mmmeMNHaup4EKSShZ53sMNgRWhsibaAIYa21jjaUUrSnIEyD2/QW+2oPNzhgpvbMS3uGWLhDwhnZKX/jx3mPuq3hrFvJAgQV5JxHdHTBdz7aDkIuiOGRM0FnEqupf7rGu8MHnCWD7wE/jKtl249RYUi7ait8PH2CdDKqG6dxCZDg/LBYDoRnneOhfiDpWNNdCelgpzs01MOCCF8f30B6Gf/N8bv0el4sO+3wpI74Vu3wvxEUBkuCM2qHRKlSKqDoNVg4ehGzd5i8W/udtBSIaZ4o3Uf0ZLV3ZmH6qzJapmdR1AJ3v3LcPZYouYS3GmUjsc0Yvp95VCcDoXMWloIwFISSLTpKODwj7xy891C0P5CClHV4/mqHZy/vcSgXy4fW4MXXDJufOQwV1l2HP1MzRCnh1rjLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Wireguard IPv6\"\n        title=\"\"\n        src=\"/static/1772291174218.96857872734/f058b/wg-ipv6.png\"\n        srcset=\"/static/1772291174218.96857872734/c26ae/wg-ipv6.png 158w,\n/static/1772291174218.96857872734/6bdcf/wg-ipv6.png 315w,\n/static/1772291174218.96857872734/f058b/wg-ipv6.png 630w,\n/static/1772291174218.96857872734/40601/wg-ipv6.png 945w,\n/static/1772291174218.96857872734/78612/wg-ipv6.png 1260w,\n/static/1772291174218.96857872734/a80b8/wg-ipv6.png 1497w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .abyss { background-color: #000c18; }\n  .abyss .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Setup WireGuard with global IPv6","date":"January 02, 2022","description":"Setup a dual stacked VPN with global IPv6 support"}},"previous":{"fields":{"slug":"/enabling-ipv6-on-maven-java/"},"frontmatter":{"title":"Enabling IPv6 on Java and Maven"}},"next":{"fields":{"slug":"/dockerhub-ipv6/"},"frontmatter":{"title":"Pull Docker Images via IPv6"}}},"pageContext":{"id":"56eafbb9-6e1d-5d04-a175-202b73af7b99","previousPostId":"70fb4087-892e-5804-8ac5-04a6213827f8","nextPostId":"84ef6383-f366-591f-9937-ccfa1158b5f3"}},"staticQueryHashes":["1888224856","2841359383"],"slicesMap":{}}