{"componentChunkName":"component---src-templates-blog-post-js","path":"/cw-alarms-using-tfcdk-2/","result":{"data":{"site":{"siteMetadata":{"title":"Miyuru Tech Blog"}},"markdownRemark":{"id":"6a74a462-6134-5478-b13c-59ae2e589b46","excerpt":"ðŸ’‰ Find part 1 of the article here. https://blog.miyuru.lk/cw-alarms-using-tfcdk-1/ In this post, letâ€™s spice things up using loops and boto3. Letâ€™s say youâ€¦","html":"<blockquote>\n<p>ðŸ’‰ Find part 1 of the article here. <a href=\"https://blog.miyuru.lk/cw-alarms-using-tfcdk-1/\">https://blog.miyuru.lk/cw-alarms-using-tfcdk-1/</a></p>\n</blockquote>\n<p>In this post, letâ€™s spice things up using loops and boto3.</p>\n<p>Letâ€™s say you need to define multiple alarms with different thresholds.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> constructs </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> Construct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> cdktf </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> TerraformStack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> imports.aws </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> AwsProvider, CloudwatchMetricAlarm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">thresholds </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">75</span><span class=\"mtk1\">,</span><span class=\"mtk4\">85</span><span class=\"mtk1\">,</span><span class=\"mtk4\">95</span><span class=\"mtk1\">,</span><span class=\"mtk4\">99</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">evaluation_periods </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">period </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">60</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">statistic </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;Average&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">comparison_operator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;GreaterThanOrEqualToThreshold&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">metric_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPUUtilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">namespace </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;AWS/EC2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> threshold_values </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> thresholds:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    insid </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;i-000123456789&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    dimensions</span><span class=\"mtk7\">=</span><span class=\"mtk15 mtki\">dict</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">InstanceId</span><span class=\"mtk7\">=</span><span class=\"mtk1\">insid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    threshold </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> threshold_values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    alarm_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPU-Utilization-Test-Alarm-&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk15 mtki\">str</span><span class=\"mtk1\">(threshold_values)</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;%&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    alarm_description </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;This metric monitors EC2 &quot;</span><span class=\"mtk7\">+</span><span class=\"mtk15 mtki\">str</span><span class=\"mtk1\">(threshold_values)</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot; CPU utilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    CloudwatchMetricAlarm(self, </span><span class=\"mtk11\">&quot;Alarm&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">alarm_name, </span><span class=\"mtk4\">...</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>This code will create 4 alarms that will trigger at 4 trigger points. If you need to add more trigger points its easy as adding value to the array.</p>\n<p>Now if you want to create an alarm for instances in an autoscale group or using tags, we can use boto3 to get the data.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> constructs </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> Construct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> cdktf </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> TerraformStack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> imports.aws </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> AwsProvider, CloudwatchMetricAlarm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> boto3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">region </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;eu-west-1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">profile </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;test&quot;</span><span class=\"mtk1\">  </span><span class=\"mtk3\">#change this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ec2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> boto3.client(</span><span class=\"mtk11\">&#39;ec2&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk19 mtki\">region_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">region, </span><span class=\"mtk19 mtki\">endpoint_url</span><span class=\"mtk7\">=</span><span class=\"mtk11\">&quot;https://api.ec2.&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">region</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;.aws&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">boto3.setup_default_session(</span><span class=\"mtk19 mtki\">profile_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">profile)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">thresholds </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">75</span><span class=\"mtk1\">,</span><span class=\"mtk4\">85</span><span class=\"mtk1\">,</span><span class=\"mtk4\">95</span><span class=\"mtk1\">,</span><span class=\"mtk4\">99</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">evaluation_periods </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">period </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">60</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">statistic </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;Average&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">comparison_operator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;GreaterThanOrEqualToThreshold&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">metric_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPUUtilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">namespace </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;AWS/EC2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">asg_group_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;test-asg&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ec2.describe_instances(</span><span class=\"mtk19 mtki\">Filters</span><span class=\"mtk7\">=</span><span class=\"mtk1\">[{</span><span class=\"mtk11\">&#39;Name&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk11\">&#39;instance-state-name&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;Values&#39;</span><span class=\"mtk1\">: [</span><span class=\"mtk11\">&#39;running&#39;</span><span class=\"mtk1\">]},{</span><span class=\"mtk11\">&#39;Name&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk11\">&#39;tag:aws:autoscaling:groupName&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;Values&#39;</span><span class=\"mtk1\">: [asg_group_name]}])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> res </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> response[</span><span class=\"mtk11\">&#39;Reservations&#39;</span><span class=\"mtk1\">]:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> ins </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> res[</span><span class=\"mtk11\">&#39;Instances&#39;</span><span class=\"mtk1\">]:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        insid</span><span class=\"mtk7\">=</span><span class=\"mtk1\">ins[</span><span class=\"mtk11\">&quot;InstanceId&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">print</span><span class=\"mtk1\"> (insid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> threshold_values </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> thresholds:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dimensions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk15 mtki\">dict</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">InstanceId</span><span class=\"mtk7\">=</span><span class=\"mtk1\">insid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            threshold </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> threshold_values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            alarm_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPU-Utilization-Test-Alarm-&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk15 mtki\">str</span><span class=\"mtk1\">(threshold_values)</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;%&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            alarm_description </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;This metric monitors EC2 CPU utilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            CloudwatchMetricAlarm(self, </span><span class=\"mtk11\">&quot;Alarm&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">alarm_name, </span><span class=\"mtk4\">...</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>This code will call the autoscaling API, get the instance IDs and create alarms for each instance with different thresholds.</p>\n<p>Here is the completed code.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">#!/usr/bin/env python</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> constructs </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> Construct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> cdktf </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> App, TerraformStack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> imports.aws </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> AwsProvider, CloudwatchMetricAlarm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> boto3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">region </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;eu-west-1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">profile </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;test&quot;</span><span class=\"mtk1\">  </span><span class=\"mtk3\">#change this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">boto3.setup_default_session(</span><span class=\"mtk19 mtki\">profile_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">profile)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">ec2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> boto3.client(</span><span class=\"mtk11\">&#39;ec2&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk19 mtki\">region_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">region, </span><span class=\"mtk19 mtki\">endpoint_url</span><span class=\"mtk7\">=</span><span class=\"mtk11\">&quot;https://api.ec2.&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">region</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;.aws&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">thresholds </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk4\">75</span><span class=\"mtk1\">,</span><span class=\"mtk4\">85</span><span class=\"mtk1\">,</span><span class=\"mtk4\">95</span><span class=\"mtk1\">,</span><span class=\"mtk4\">99</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">evaluation_periods </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">period </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">60</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">statistic </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;Average&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">comparison_operator </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;GreaterThanOrEqualToThreshold&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">metric_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPUUtilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">namespace </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;AWS/EC2&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">asg_group_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;test-asg&quot;</span><span class=\"mtk1\">  </span><span class=\"mtk3\">#change this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">alarm_actions </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">MyStack</span><span class=\"mtk1\">(</span><span class=\"mtk6 mtki mtku\">TerraformStack</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk15\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk19 mtki\">scope</span><span class=\"mtk1\">: Construct, </span><span class=\"mtk19 mtki\">ns</span><span class=\"mtk1\">: </span><span class=\"mtk15 mtki\">str</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15 mtki\">super</span><span class=\"mtk1\">().</span><span class=\"mtk15\">__init__</span><span class=\"mtk1\">(scope, ns)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    AwsProvider(self, </span><span class=\"mtk11\">&#39;Aws&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk19 mtki\">region</span><span class=\"mtk7\">=</span><span class=\"mtk1\">region, </span><span class=\"mtk19 mtki\">profile</span><span class=\"mtk7\">=</span><span class=\"mtk1\">profile)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    response </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ec2.describe_instances(</span><span class=\"mtk19 mtki\">Filters</span><span class=\"mtk7\">=</span><span class=\"mtk1\">[{</span><span class=\"mtk11\">&#39;Name&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk11\">&#39;tag:aws:autoscaling:groupName&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;Values&#39;</span><span class=\"mtk1\">: [asg_group_name]},{</span><span class=\"mtk11\">&#39;Name&#39;</span><span class=\"mtk1\">: </span><span class=\"mtk11\">&#39;instance-state-name&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;Values&#39;</span><span class=\"mtk1\">: [</span><span class=\"mtk11\">&#39;running&#39;</span><span class=\"mtk1\">]}])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> res </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> response[</span><span class=\"mtk11\">&#39;Reservations&#39;</span><span class=\"mtk1\">]:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> ins </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> res[</span><span class=\"mtk11\">&#39;Instances&#39;</span><span class=\"mtk1\">]:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        insid</span><span class=\"mtk7\">=</span><span class=\"mtk1\">ins[</span><span class=\"mtk11\">&quot;InstanceId&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">print</span><span class=\"mtk1\"> (insid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> threshold_values </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> thresholds:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          dimensions</span><span class=\"mtk7\">=</span><span class=\"mtk15 mtki\">dict</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">InstanceId</span><span class=\"mtk7\">=</span><span class=\"mtk1\">insid)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          threshold </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> threshold_values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          alarm_name </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;CPU-Utilization-Test-Alarm-&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk15 mtki\">str</span><span class=\"mtk1\">(threshold_values)</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;%&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          alarm_description </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;This metric monitors EC2 CPU utilization&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          CloudwatchMetricAlarm(self, </span><span class=\"mtk11\">&quot;Test Alarm-&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">alarm_name</span><span class=\"mtk7\">+</span><span class=\"mtk11\">&quot;-&quot;</span><span class=\"mtk7\">+</span><span class=\"mtk1\">insid, </span><span class=\"mtk19 mtki\">alarm_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">alarm_name, </span><span class=\"mtk19 mtki\">comparison_operator</span><span class=\"mtk7\">=</span><span class=\"mtk1\">comparison_operator, </span><span class=\"mtk19 mtki\">evaluation_periods</span><span class=\"mtk7\">=</span><span class=\"mtk1\">evaluation_periods, </span><span class=\"mtk19 mtki\">dimensions</span><span class=\"mtk7\">=</span><span class=\"mtk1\">dimensions, </span><span class=\"mtk19 mtki\">metric_name</span><span class=\"mtk7\">=</span><span class=\"mtk1\">metric_name, </span><span class=\"mtk19 mtki\">namespace</span><span class=\"mtk7\">=</span><span class=\"mtk1\">namespace, </span><span class=\"mtk19 mtki\">period</span><span class=\"mtk7\">=</span><span class=\"mtk1\">period, </span><span class=\"mtk19 mtki\">statistic</span><span class=\"mtk7\">=</span><span class=\"mtk1\">statistic, </span><span class=\"mtk19 mtki\">threshold</span><span class=\"mtk7\">=</span><span class=\"mtk1\">threshold, </span><span class=\"mtk19 mtki\">alarm_description</span><span class=\"mtk7\">=</span><span class=\"mtk1\">alarm_description, </span><span class=\"mtk19 mtki\">alarm_actions</span><span class=\"mtk7\">=</span><span class=\"mtk1\">alarm_actions)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">app </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> App()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">MyStack(app, </span><span class=\"mtk11\">&quot;cdkalarms&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">app.synth()</span></span></span></code></pre>\n<blockquote>\n<p>ðŸ‘‰ Remember to create an auto scaling group and change the variables accordingly.</p>\n</blockquote>\n<p>To deploy the it, run</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cdktf deploy</span></span></span></code></pre>\n<p>The alarms should be now created.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1772291174211.63627872569/2bef9/cdktf_alarms_created.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABGvAAARrwH3/UuEAAABtUlEQVR42lWTyZbcIAxF/U856SxSLozNjDFVLk/Vq87/f8SLkIekF+8ISyBdCVzZQcPPDmp0aJ8Rtcv4UXv8bHpSZH3Q+oO/i8Lhp7WIuCmPW2dRk/0lFKp1XjA9J6SYEHxEzgPG5wNtK1HXv9GIO+73G4Sov6k57P1e4oKtEALV+Brx9ecLyzIjxIC+71mv14TXNO2WFEKAsRbee1iyxuwqa3v4lSJCKSWcc+zsyNG2LQeXhcgp4TzPWNeVE5Z9ReXgKa31ZbuuQ2Ws4UPjOPLmcrAQliSntm1jn6NCnuJMeJAxDOkiLFlL4KykyJbg4/HEMAxIaSCbOYExhvdI2XIn/9SxLd1W2mhujwkpUYiRaBLmZWWVWKGM5HcHyUlXurPOMqHzgYppVG3XXpULbdcpPpjzgwmLcs57Fxeh/K6DdCfUCsu60I2+uHqZUUoJ7/ebZ7euGzZax9jvM47hutlrhva/GSrqX8kOUkiWqGsYKpL6SO/SIQZPIyjttERPJLLht3lKNAJN01yq0koP+tPTX9LCTTSXlBGGDS4tUH6EJ2v7BY3OEF2/Sw2s4tPa8IM+E/4F4bGUv5aUJTMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Terminal CDKTF Alarm\"\n        title=\"\"\n        src=\"/static/1772291174211.63627872569/f058b/cdktf_alarms_created.png\"\n        srcset=\"/static/1772291174211.63627872569/c26ae/cdktf_alarms_created.png 158w,\n/static/1772291174211.63627872569/6bdcf/cdktf_alarms_created.png 315w,\n/static/1772291174211.63627872569/f058b/cdktf_alarms_created.png 630w,\n/static/1772291174211.63627872569/40601/cdktf_alarms_created.png 945w,\n/static/1772291174211.63627872569/2bef9/cdktf_alarms_created.png 1024w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nYou can view it the console as well.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1772291174209.6367872568/098c1/aws_alarms.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.177215189873415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABGvAAARrwH3/UuEAAABO0lEQVR42j2RW3KsMAxE2f8CsptbWUEqX/c3qVR4e5gBZFt+MHQkTTJQqsZgHTXtpndXuOWGfd8RQrAiIltrkfdWXmrTtX7/Ld3rI4NcC/p4A42faJxz2LYNx3Gg1mqVEj+BOWfkUkQLmBleYV5gMRqQ6wn+ege9voD+/0Ojm9SRNipMVZtUdYg2rTIwpYQokOV6NfAfPMt74oQMINUDTREIccYtZOxckModPpFogl4hRNzWFVEACr9cLniY8NjNSJE4CCUzzrsA1VXMB9ZYBJjBAuQSkWs2oDZrYxLHBlzEobjy4ZFtkTjUuRo75W70tzQHEmgQmIhYZ9R7MaDmpyAdrOqeDskGFcv3Ec95CnCRid0443uY0A4zhsmhn3qM8yhuFgzjiLbrTO257TBN03M9y6F2fW+D9KB+ALgAGwTkoOB8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Terminal CDKTF Alarm\"\n        title=\"\"\n        src=\"/static/1772291174209.6367872568/f058b/aws_alarms.png\"\n        srcset=\"/static/1772291174209.6367872568/c26ae/aws_alarms.png 158w,\n/static/1772291174209.6367872568/6bdcf/aws_alarms.png 315w,\n/static/1772291174209.6367872568/f058b/aws_alarms.png 630w,\n/static/1772291174209.6367872568/40601/aws_alarms.png 945w,\n/static/1772291174209.6367872568/78612/aws_alarms.png 1260w,\n/static/1772291174209.6367872568/098c1/aws_alarms.png 1578w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To delete the test alarms, run</p>\n<pre class=\"grvsc-container abyss\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cdktf destroy</span></span></span></code></pre>\n<p>The documentation and stackoverflow answers for Terraform CDK is non existent at the moment. So if an error occurs, it might be hard to track it down. Search the github issues if you encounter problem. <a href=\"https://github.com/hashicorp/terraform-cdk/issues\">https://github.com/hashicorp/terraform-cdk/issues</a></p>\n<p>From this post, you can see how Terraform CDK can help you easily manage terraform code.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .abyss { background-color: #000c18; }\n  .abyss .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .abyss .mtki { font-style: italic; }\n  .abyss .mtk3 { color: #384887; }\n  .abyss .mtk7 { color: #225588; }\n  .abyss .mtk1 { color: #6688CC; }\n  .abyss .mtk4 { color: #F280D0; }\n  .abyss .mtk11 { color: #22AA44; }\n  .abyss .mtk15 { color: #9966B8; }\n  .abyss .mtk19 { color: #2277FF; }\n  .abyss .mtk5 { color: #FFEEBB; }\n  .abyss .mtk6 { color: #DDBB88; }\n  .abyss .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Creating CloudWatch Alarms using Terraform CDK (Part 2)","date":"August 01, 2021","description":"Creating CloudWatch Alarms using Terraform CDK "}},"previous":{"fields":{"slug":"/cw-alarms-using-tfcdk-1/"},"frontmatter":{"title":"Creating CloudWatch Alarms using Terraform CDK (Part 1)"}},"next":{"fields":{"slug":"/using-ipv6-to-github-pages-on-custom-domains/"},"frontmatter":{"title":"Using IPv6 to serve github pages on custom domains"}}},"pageContext":{"id":"6a74a462-6134-5478-b13c-59ae2e589b46","previousPostId":"479aeca2-338f-51e9-bd20-265b1b4b082e","nextPostId":"ed82f766-83c0-53bb-88df-f44a00699014"}},"staticQueryHashes":["1888224856","2841359383"],"slicesMap":{}}